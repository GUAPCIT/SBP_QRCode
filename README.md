# Генерация qr-кода для оплаты через СБП


## Сценарий работы системы

1.	Заполнение формы оплаты на сайте ГУАП
2.	Отправка запроса на qr-код
+   2.1. Сохранение данных формы в базе сайта ГУАП (сохраняются все введенные данные и присваивается id)
+   2.2. Запрос в QRM на получение qr-кода (в поле purpose передается Id из базы сайта ГУАП + назначение + договор + параметры. Все в строке не более 255 символов)
+   2.3. Получение ответа от QRM (картинка, ссылка на СБП, номер заказа, uuid)
3.	Отображение результата плательщику (qr-код или сообщение об ошибке)
4.	Плательщик оплачивает по qr-коду в СБП самостоятельно
5.	ОПЦИОНАЛЬНО: с помощью отдельного сервиса (вебсокет) система сайта ГУАП проверяет прохождение платежей QRM/СБП и сопоставляет их с базой сайта ГУАП
6.	Вечером в бухгалтерию приходит выписка по всем поступившим платежам, в том числе из СБП
+   6.1. Данные в выписке по СБП содержат данные поля purpose (255 символов) переданные при запросе qr-кода
+   6.2. Бухгалтерия вручную разбирает и разносит реестр платежей



## Запрос qr-кода

JSON:

      {
         "sum": 0,
         "payer": "",
         "purpose": ""
      }

Где:

| Параметр | Тип | Описание | Пример |
|---|---|---|---|
| sum | целое число | сумма платежа (**в копейках!!!**) | 123400 |
| payer | строка[255] | ФИО плательщика | "Иванов Иван Иванович" |
| purpose | строка[255] | назначение платежа в формате: `"#{id-запроса} [{назначение}] {договор} // {параметры}"` | "#12345 [обуч] 1234567-89/01 от 04.09.2021 (Иванов Иван Иванович) // за 1-2 семестр" |

- **`{id-запроса}`** уникальный идентификатор запроса на оплату через qr-код из базы сайта ГУАП.
- **`{назначение}`** может принимать значения `"обуч"` или `"прожив"`, что соответствует «Оплата за обучение» или «Оплата за проживания в общежитии».
- **`{договор}`** соответствует формату `"{номер договора} от {дата договор} ({фио обучающегося})"`.
- **`{параметры}`** произвольный текст, уточняющий детали платежа.

Примеры:

      {
         "sum": 48000,
         "payer": "Пушкин Александр Сергеевич",
         "purpose": "#123456 [обуч] 1234567-89/01 от 04.09.2021 (Лермонтов Михаил Юрьевич) // за 3-4 семестр"
      }
      
      {
         "sum": 4000,
         "payer": "Лев Николаевич Толстой",
         "purpose": "#7890123 [прожив] 2345-67/89 от 01.01.2021 (Лев Николаевич Толстой) // за сентябрь-май 2021/22 уч. года"
      }

      {
         "sum": 4000,
         "payer": "Борисова Анна Григорьевна",
         "purpose": "#4567890 [прожив] 2345-67/89 от 01.01.2021 (Брусникин Анатолий Григорьевич) // за сентябрь-май 2021/22 уч. года"
      }



## Ответ на запрос qr-кода

JSON:

      {
         "qr_code": "url изображения QR-кода заданного размера, хранящегося на сервере QRM до истечения заданного ttl или факта оплаты",
         "qr_link": "url от СБП",
         "number": "уникальный номер заказа для фискализации операции",
         "operation_id": "UUID операции для получения статуса оплаты qr-кода по веб-сокету"
      }

(далее, согласно спецификации REST API QRM)



## Данные в банковской выписке для бухгалтерии ГУАП

Выписка должна содержать следующую информацию:
- дата и время платежа
- сумма платежа
- назначение платежа (как в формате запроса qr-кода из поля purpose)
- фио плательщика


